@model List<PluginBuilder.APIModels.PublishedPlugin>?
@{
    Layout = "_LayoutPublicModal";
    const string title = "BTCPay Server Plugin Directory";
    const string desc = "Extend and customize your BTCPay Server with community and official plugins.";
    ViewData["Title"] = title;

    var currentSearch = Context.Request.Query["searchPluginName"].ToString();
    var currentSort = (string?)Context.Request.Query["sort"] ?? "smart";
    if (string.IsNullOrEmpty(currentSort)) currentSort = "smart";

    var sortLabel = currentSort switch
    {
        "rating" => "Highest rated",
        "recent" => "Most recent",
        "alpha" => "Alphabetical",
        _ => "Relevance"
    };
}

@section Meta {
    <!-- Open Graph and Twitter metadata -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="@title" />
    <meta property="og:description" content="@desc" />
    <meta property="og:site_name" content="BTCPay Server Plugin Builder" />
    <meta property="og:locale" content="en_US" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="@title" />
    <meta name="twitter:description" content="@desc" />
}

<partial name="_PublicHeader" />

<div class="container">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h3 class="display-5 fw-bold">BTCPay Server Plugin Directory</h3>
            <p class="text-muted">Extend and customize your BTCPay Server with community and official plugins.</p>
        </div>
    </div>
    <div class="row mb-4">
        <div>
            <form asp-action="AllPlugins" method="get" class="d-flex flex-wrap flex-sm-nowrap align-items-center gap-3">
                <input type="hidden" name="sort" value="@currentSort" />

                <input type="text"
                       name="searchPluginName"
                       class="form-control flex-grow-1"
                       placeholder="Search plugins or authors"
                       value="@currentSearch" />

                <div class="dropdown flex-shrink-0">
                    <button class="btn btn-secondary dropdown-toggle text-nowrap"
                            type="button"
                            id="SortOptionsToggle"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        @sortLabel
                    </button>

                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="SortOptionsToggle">
                        <a class="dropdown-item @(currentSort == "smart" ? "active" : "")"
                           asp-action="AllPlugins"
                           asp-route-searchPluginName="@currentSearch"
                           asp-route-sort="smart">
                            Relevance
                        </a>
                        <a class="dropdown-item @(currentSort == "rating" ? "active" : "")"
                           asp-action="AllPlugins"
                           asp-route-searchPluginName="@currentSearch"
                           asp-route-sort="rating">
                            Highest rated
                        </a>
                        <a class="dropdown-item @(currentSort == "recent" ? "active" : "")"
                           asp-action="AllPlugins"
                           asp-route-searchPluginName="@currentSearch"
                           asp-route-sort="recent">
                            Most recent
                        </a>
                        <a class="dropdown-item @(currentSort == "alpha" ? "active" : "")"
                           asp-action="AllPlugins"
                           asp-route-searchPluginName="@currentSearch"
                           asp-route-sort="alpha">
                            Alphabetical
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        @if (Model != null && Model.Any())
        {
            @foreach (var plugin in Model)
            {
                var owner = plugin.GetGithubRepository()?.Owner;
                <div class="col-md-6 mb-4">
                    <div class="card h-100 plugin-card" data-type="community">
                        <div class="card-body">
                            <div class="row">
                                <div style="display: flex; align-items: flex-start; margin-bottom: 20px;">
                                    <div style="margin-right: 15px;">
                                        <partial name="_PluginLogo" model="plugin" />
                                    </div>
                                    <div>
                                        <h3 style="margin-top: 0; margin-bottom: 5px;">
                                            <a asp-action="GetPluginDetails"
                                               asp-route-pluginSlug="@plugin.ProjectSlug">@plugin.PluginTitle</a>
                                        </h3>

                                        <p style="margin-bottom: 5px;">
                                            @plugin.Description.Truncate(300)
                                        </p>

                                        <div style="font-size: 0.875em; color: #6c757d;">
                                            <div style="margin-bottom: 3px;">
                                                <span>by <a href="https://github.com/@owner" rel="noreferrer noopener" target="_blank">@owner</a></span>
                                            </div>
                                            <div>
                                                Version: @plugin.Version - Published:
                                                @(DateTimeOffset.TryParse(plugin.BuildInfo?["buildDate"]?.ToString(), out var parsedDate)
                                                    ? parsedDate.ToString("MMM dd, yyyy")
                                                    : "")
                                            </div>

                                            <div class="mt-2 w-100 text-start d-flex align-items-center gap-2">
                                                <partial name="_RatingInline"
                                                         model="@(new RatingInlineViewModel
                                                                {
                                                                    Average = plugin.RatingSummary?.Average ?? 0m,
                                                                    TotalReviews = plugin.RatingSummary?.TotalReviews ?? 0,
                                                                    ShowNumber = false,
                                                                    ShowTotalReviews = true,
                                                                    AriaLabelPrefix = plugin.PluginTitle ?? plugin.ManifestInfo?["Name"]?.ToString()
                                                                })" />
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center py-5">
                <h4>No plugins available yet</h4>
                <p class="text-muted">Check back later, or
                    <a asp-action="Login" asp-controller="Home" class="text-success text-decoration-none">login to upload one</a>
                </p>
            </div>
        }
    </div>
</div>
