@model AccountDetailsViewModel
@{
    Layout = "_Layout";
    ViewData.SetActivePage("Account Settings");

	var gpgKey = Model.Settings.GPGKey;
	var hasKey = !string.IsNullOrEmpty(gpgKey?.Fingerprint);
	DateTimeOffset? expiryDate = gpgKey?.ValidDays > 0 ? gpgKey.CreatedDate.AddDays(gpgKey.ValidDays) : null;
	var isExpired = expiryDate.HasValue && expiryDate.Value <= DateTimeOffset.UtcNow;
	var isExpiringSoon = expiryDate.HasValue && expiryDate.Value <= DateTimeOffset.UtcNow.AddMonths(1);
}

<h2 class="mt-1 mb-4">@ViewData["Title"]</h2>
<div class="row">
    <div class="col-xl-8 col-xxl-constrain">
        <form asp-action="AccountDetails">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="AccountEmail" class="form-label"></label>
                @if (Model.AccountEmailConfirmed)
                {
                    <span class="badge bg-success ml-2">Confirmed</span>
                }
                <div class="input-group">
                    <input asp-for="AccountEmail" class="form-control" readonly="readonly" />
                    @if (Model.NeedToVerifyEmail)
                    {
                        <div class="input-group-append">
							<a asp-controller="Account" asp-action="VerifyEmail" class="btn btn-outline-success ms-2">Verify Email</a>
                        </div>
                    }
                </div>
            </div>
            <div class="form-group">
                <label asp-for="Settings.Github" class="form-label"></label>
                @if (Model.GithubAccountVerified)
                {
                    <span class="badge bg-success ml-2">Confirmed</span>
                }
                <div class="input-group">
                    <input asp-for="Settings.Github" class="form-control" placeholder="https://github.com/satoshi" readonly="readonly" />
                    @if (!Model.GithubAccountVerified)
                    {
                        <div class="input-group-append">
							<a asp-controller="Account" asp-action="VerifyGithubAccount" class="btn btn-outline-success ms-2">Verify GitHub</a>
                        </div>
                    }
                </div>
            </div>

            <div class="form-group">
                <label asp-for="Settings.Nostr!.Npub" class="form-label"></label>
                @if (Model.IsNostrVerified)
                {
                    <span class="badge bg-success ms-2">Confirmed</span>
                }
                <div class="d-flex align-items-center">
                    <input asp-for="Settings.Nostr!.Npub" class="form-control" placeholder="npubâ€¦" readonly="readonly"/>

                    @if (!Model.IsNostrVerified)
                    {
                        <div class="btn-group ms-2">
                            <button type="button"
                                    id="btn-verify-dropdown"
                                    class="btn btn-outline-success dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    aria-haspopup="true">
                                Verify Nostr
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <button type="button" class="dropdown-item" id="action-verify-extension">
                                        Extension (Nip07)
                                    </button>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       id="action-verify-manual"
                                       asp-controller="Account"
                                       asp-action="NostrVerifyPublicNote">
                                        Manually (Public Note)
                                    </a>
                                </li>
                            </ul>
                        </div>
                    }
                </div>

                @if (!Model.IsNostrVerified)
                {
                    <small class="text-muted d-block mt-1">
                        Choose between verifying your Nostr account using an extension (NIP-07) or by publishing a public note (Manually)
                    </small>
                }
                <div id="nostr-verify-status" class="mt-2"></div>
            </div>

            <div class="form-group">
                <label asp-for="Settings.Twitter" class="form-label"></label>
                <input asp-for="Settings.Twitter" class="form-control" placeholder="https://twitter.com/satoshi" />
                <span asp-validation-for="Settings.Twitter" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Settings.Email" class="form-label"></label>
                <input asp-for="Settings.Email" class="form-control" type="email" placeholder="plugins@satoshi.com" />
                <span asp-validation-for="Settings.Email" class="text-danger"></span>
            </div>

			<div class="form-group">
				<label asp-for="Settings.GPGKey!.PublicKey" class="form-label">GPG Public Key</label>
				@if (hasKey && (!expiryDate.HasValue || !isExpired))
				{
					<span class="badge bg-success ms-2">Confirmed</span>
				}
				@if (isExpired)
				{
					<div class="alert alert-danger mt-2">Your GPG key expired on @expiryDate?.ToString("yyyy-MM-dd")</div>
				}
				else if (isExpiringSoon)
				{
					<div class="alert alert-warning mt-2">Your GPG key will expire on @expiryDate?.ToString("yyyy-MM-dd")</div>
				}
				<div>
					@if (!string.IsNullOrEmpty(Model.Settings.GPGKey?.Fingerprint))
					{
						<div id="existing-key-section" class="d-flex align-items-center">
							<input class="form-control" readonly value="Fingerprint: @Model.Settings.GPGKey?.Fingerprint" />
							<button type="button" class="btn btn-outline-danger ms-2" onclick="showResetKeyForm();">
								Replace
							</button>
						</div>

						<div id="reset-key-section" class="mt-3" style="display:none;">
							<textarea asp-for="Settings.GPGKey!.PublicKey" class="form-control" rows="8"
									  placeholder="Paste your armored GPG public key here..."></textarea>
							<span asp-validation-for="Settings.GPGKey!.PublicKey" class="text-danger"></span>
						</div>
					}
					else
					{
						<textarea asp-for="Settings.GPGKey!.PublicKey" class="form-control" rows="8" placeholder="Paste your armored GPG public key here..."></textarea>
						<span asp-validation-for="Settings.GPGKey!.PublicKey" class="text-danger"></span>
					}
				</div>
			</div>

            <div class="form-group mt-4">
                <input type="submit" class="btn btn-primary" id="Save" value="Save" />
            </div>
        </form>
    </div>
</div>

@section FooterScripts {
    <script>
        function showResetKeyForm() {
            const existing = document.getElementById("existing-key-section");
            const reset = document.getElementById("reset-key-section");

            if (reset.style.display === "none" || reset.style.display === "") {
                existing.style.display = "none";
                reset.style.display = "block";
            } else {
                reset.style.display = "none";
                existing.style.display = "flex";
            }
        }

        const $btn = document.getElementById('action-verify-extension');
        const $status = document.getElementById('nostr-verify-status');
        const host = location.hostname;

        function show(msg, cls) {
            $status.innerHTML = `<div class="alert ${cls} py-2 my-2">${msg}</div>`;
        }

        async function getNip07Payload(){
            const r = await fetch('/account/nostr/nip07-payload', { method: 'GET' });
            if(!r.ok) throw new Error(await r.text());
            return r.json();
        }

        async function verifyWithNip07(challengeToken, ev){
            const r = await fetch('/account/nostr/verify-nip07', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ challengeToken, event: ev })
            });
            if(!r.ok) throw new Error(await r.text());
        }

        async function nip07Flow() {
            if (!window.nostr) throw new Error('No NIP-07 extension detected');
            const payload = await getNip07Payload();
            const pubkey = await window.nostr.getPublicKey();
            const unsigned = {
              kind: 1,
              created_at: Math.floor(Date.now()/1000),
              content: payload.message,
              tags: [
                ["purpose","pluginbuilder-verification"],
                ["challenge", payload.challengeToken]
              ],
              pubkey: pubkey
            };
            const signed = await window.nostr.signEvent(unsigned);
            await verifyWithNip07(payload.challengeToken, signed);
            location.reload();
        }

        $btn?.addEventListener('click', async () => {
            $btn.disabled = true;
            try {
              await nip07Flow();
            } catch (e) {
              show('Verification failed: ' + (e?.message || e),'alert-danger');
            } finally {
              $btn.disabled = false;
            }
        });
    </script>
}
